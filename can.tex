Wybór sposobu przekazu informacji wewn¹trz pojazdu musi spe³niaæ wszystkie za³o¿enia projektu zawarte w \hyperref[sec:analiza]{Sekcji~\ref*{sec:analiza}: Analiza problemu}. Zdecydowano siê na u¿ycie magistrali Cotroller Area Network ($CAN$). Jest to protokó³ komunikacyjny wykorzystywany przez sterownik silnika (Electronic Control Unit - $ECU$) serii PE3~\cite{manual:ecu}, który zosta³ wybrany przez konstruktorów pojazdu. $CAN$ to powszechnie stosowany standard w systemach automatyki przemys³owej i samochodowej. Charakteryzuje siê wysokim bezpieczeñstwem transmisji (odpornoœci¹ na b³êdy). Pozwala na przesy³anie mikrostrumieni danych, takich jak uzyskiwane dane z czujników, sk³adaj¹cych siê z 1 do 8 bitów na komunikat. Topologia magistrali wymaga u¿ycia mniejszej iloœci przewodów ni¿ np. topologia gwiazdy.

\subsection{CAN w modelu ISO/OSI} \label{sec:sub:iso}
$CAN$ to standard przemys³owej sieci transmisyjnej stworzonej na pocz¹tku lat 80. przez niemieck¹ firmê Bosch. Jak ka¿dy powszechnie stosowany protokó³ komunikacyjny, tak i $CAN$ zosta³ w roku 1993  zestandaryzowany i opisany przez International Standard Organisation ($ISO$) na warstwach modelu ISO/OSI i przyjêty za normê ISO-11898~\cite{article:siecican}\cite{iso:11898} (\hyperref[fig:ISO/OSI]{Rysunek~\ref*{fig:ISO/OSI}}).  Standard $CAN$ mia³ obejmowaæ warstwy 1.~(fizyczn¹) 2.~(³¹cza danych) oraz 7.~(aplikacji) \cite{article:can}.\\

\begin  {figure} [h] 
\centering
\includegraphics[width=0.75\textwidth]{figures/CAN_ISO_OSI.JPG}
\caption{$CAN$ w modelu ISO/OSI~\cite{article:can}}
\label{fig:ISO/OSI}
\end {figure}

W warstwie fizycznej istniej¹ dwie wersje protoko³u:
\begin{itemize}
\item \textit{Low Speed CAN} od 5 kb/s do 125 kb/s
\item \textit{High Speed CAN} do 1 Mb/s
\end{itemize}
Wersje te jednak nie opisuj¹ bezpoœrednio realizacji fizycznej transmisji sygna³u. Powsta³o wiele dokumentów, które uœciœlaj¹ to zagadnienie. Sygna³ musi byæ sygna³em ró¿nicowym, a najczêœciej stosowanym medium jest skrêtka dwóch przewodów, ekranowanych lub nie. Przesy³ ró¿nicowy zapobiega zniekszta³ceniu sygna³u przez zak³ócenia. Topologia sieci to magistrala, co oznacza, ¿e wszystkie elementy sieci pod³¹czone s¹ do wspólnej pary przewodów. 

W nowszej wersji specyfikacji (oznaczanej $CAN$ 2.0), która jest odpowiedzi¹ na rosn¹ce zapotrzebowanie, warstwa ³¹cza danych podzielona jest na dwie czêœci:
\begin{itemize}
\item Logical Link Control ($LLC$) odpowiedzialn¹ za retransmisjê danych, zarz¹dzanie filtrami identyfikatorów oraz sygnalizacjê przepe³nieñ skrzynek odbiorczych i nadawczych.
\item Media Access Control ($MAC$) odpowiedzialn¹ za dostêp do medium, kodowanie i enkapsulacjê danych oraz wykrywanie b³êdów transmisji.
\end{itemize}

Dostêp do medium realizowany jest poprzez wyró¿nienie dwóch stanów magistrali: dominuj¹cego i recesywnego. (Poziomy napiêæ przedstawiono w \hyperref[tab:voltage]{Tabeli~\ref*{tab:voltage}}. Standard ISO-11898 mo¿e byæ stosowany równie¿ w sieciach o ni¿szych prêdkoœciach, dlatego zaprezentowano go jako uniwersalny). 

\begin{table}[h]
\begin{center}
\begin{tabular}{|l|c|c|}
\hline
\rowcolor[HTML]{C0C0C0} 
\cellcolor[HTML]{C0C0C0} & \multicolumn{2}{l|}{\cellcolor[HTML]{C0C0C0}\textbf{Stan magistrali}} \\ \cline{2-3} 
\rowcolor[HTML]{C0C0C0} 
\multirow{-2}{*}{\cellcolor[HTML]{C0C0C0}\textbf{\begin{tabular}[c]{@{}l@{}}Napiêcie na \\ magistrali\end{tabular}}} & \multicolumn{1}{l|}{\cellcolor[HTML]{C0C0C0}\textbf{recesywny}} & \multicolumn{1}{l|}{\cellcolor[HTML]{C0C0C0}\textbf{dominuj¹cy}} \\ \hline \hline
CANH & 2.5 V & 3.5 V \\ \hline
CANL & 2.5 V & 1.5 V \\ \hline
\begin{tabular}[c]{@{}l@{}}dopuszczalne\\ napiêcie\\ ró¿nicowe\\ $U_{0}=CANH-CANL$\end{tabular} & 0 - 0.5 V & 0.9 - 2.0 V \\ \hline
\end{tabular}
\end{center}
\caption{Poziomy napiêæ na magistrali $CAN$}\label{tab:voltage}
\end{table}

Je¿eli urz¹dzenia magistrali wymusz¹ jednoczeœnie stan recesywny i dominuj¹cy, to na linii ustabilizuje siê stan dominuj¹cy. Taki system dostêpu do medium jest potocznie zwany "iloczynem na drucie". Na \hyperref[fig:CAN_bit]{Rysunku~\ref*{fig:CAN_bit}} przedstawiono ró¿nicowy sygna³ bêd¹cy reprezentacj¹ jednego bitu.

\begin  {figure} [h] 
\centering
\includegraphics[width=0.75\textwidth]{figures/CAN_bit.JPG}
\caption{Sygna³ ró¿nicowy miêdzy $CANH$ i $CANL$~\cite{manual:transceiver1}}
\label{fig:CAN_bit}
\end {figure}

Warstwa ³¹cza danych obs³ugiwana jest sprzêtowo przez kontrolery magistrali $CAN$, które spotykane s¹ jako integralne czêœci niektórych mikrokontrolerów.\\

Istnieje bardzo wiele ró¿nych standardów opartych na warstwie aplikacji. Ka¿dy producent opracowuje swój standard. Wyró¿nia siê: 
\begin{itemize} \label{itemize:can}
\item $CANopen$ oparty na standardzie grupy $CiA$ (CAN in Automation - standard DS 301). Jest to bardzo popularny protokó³, u¿ywany w systemach wbudowanych.
\item $CAN Areospace$ - standard wprowadzony przez $NASA$ (National Aeronautic and Space Administration). U¿ywany jest do systemu kontrolno-nawigacyjnego.
\item $CAN Kingdom$ - specyfikacja warstwy aplikacji stworzona przez szwedzka firmê Kvaser AB. Daje on projektantom swobodê w tworzeniu w³asnego systemu, otwieraj¹c mo¿liwoœæ do projektowania systemu modu³owego.
\item $Device Net$ - szeroko stosowany w aplikacjach automatyki przemys³owej.
\item $SDS$ - (Smart Distributed System) - specyfikacja stworzona przez firmê Honeywell, zajmuj¹c¹ siê systemami steruj¹cymi oraz kontrolno-pomiarowymi.
\item $SafetyBus$ - standard opracowany przez grupê Safety Network International e.V. Stosowany w przemyœle transportowym, i automatyce przemys³owej.
\item $SAE$ - standard zdefiniowany przez grupê Society of Automotive Engineers. Stosowany jest jako system komunikacji urz¹dzeñ kontrolnych, pomiarowych w samochodach osobowych (J1850) i ciê¿arowych (J1939)~\cite{misc:canbus}.
\end{itemize}

Oraz wiele innych, bêd¹cych wariacjami powy¿szych.

\subsection{Budowa ramki CAN} \label{sec:sub:ramkacan}
Wyró¿nia siê podzia³ standardu $CAN$ na dwie kolejne grupy wewn¹trz warstwy ³¹cza danych:
\begin{itemize}
\item \textit CAN 2.0 A - podstawow¹
\item \textit CAN 2.0 B - rozszerzon¹
\end{itemize}
Podzia³ ten ogranicza siê do budowy ramki, a przede wszystkim do d³ugoœci pola arbitra¿u wiadomoœci. Podstawowa wersja ramki posiada 11-bitowy identyfikator (\hyperref[fig:subfig:canstd]{Rysunek~\ref*{fig:subfig:canstd}}), natomiast rozszerzona 29-bitowy (\hyperref[fig:subfig:canext]{Rysunek~\ref*{fig:subfig:canext}}). Dobrze zaprojektowany system mo¿e skutecznie ³¹czyæ w sobie obie wersje protoko³u.

\begin{figure} [h]
\centering
%%----start of first subfigure----
	\subfloat[Standardowa ramka]{\label{fig:subfig:canstd} 
	\includegraphics[width=\textwidth]{figures/CAN_frame.JPG}}
	\\
%%----start of second subfigure----
	\subfloat[Rozszerzony nag³ówek]{\label{fig:subfig:canext}
	\includegraphics[width=0.9\textwidth]{figures/CAN_ext.JPG}}
	\caption{Ramka $CAN$ \cite{article:siecican}}
	\label{fig:canframe} %% label for entire figure
\end{figure}

Po polu arbitra¿u nastêpuje pole kontrolne, w którym zapisana jest informacja o iloœci przesy³anych danych. Kod $DLC$ (Data Length Code) to nic innego, tylko zapis binarny liczby bajtów przes³anych w polu danych. Maksymalna liczba to 8, czyli zakres wartoœci $DLC$ wynosi od 0b0000 do 0b1000~\cite{manual:stm32f4}.\\

Pole danych jest opcjonalne, gdy¿ istniej¹ ramki, które s¹ go pozbawione, jak ramka ¿¹dania transmisji czy ramka przepe³nienia.

\subsection{Czas trwania bitu}
Czas trwania jednego przesy³anego bitu podzielony jest na:

\begin{itemize}
\item Segment synchronizacyjny ($SYNC$\_$SEG$)
\item Segment 1 ($BS1$) sk³adaj¹cy siê z segmentu propagacji sygna³u oraz segmentu fazy
\item Segment 2 ($BS2$) bêd¹cy segmentem fazy
\end{itemize}

Segmenty te widoczne s¹ na (\hyperref[fig:timing]{Rysunku~\ref*{fig:timing}}):

\begin  {figure} [h] 
\centering
\includegraphics[width=\textwidth]{figures/Bit_timing.JPG}
\caption{Podzia³ czasu trwania bitu na magistrali $CAN$}
\label{fig:timing}
\end {figure}

Ka¿dy segment trwa wielokrotnoœæ kwantu czasu. Segment synchronizacji zawsze trwa jeden kwant czasu. Jest to czas, w którym oczekiwane jest zbocze przesy³anego bitu. Segment propagacji to kompensacja opóŸnienia transportowego sygna³u, bêd¹cego sum¹ opóŸnieñ urz¹dzeñ wejœciowych, wyjœciowych oraz medium. Segmenty fazy okreœlaj¹ wyst¹pienie punktu próbkowania ($SAMPLE$\_$POINT$), który wypada dok³adnie na granicy segmentów $BS1$ i $BS2$.\\

Stan linii badany jest co kwant czasu i porównywany jest ze stanem odczytanym w punkcie próbowania poprzedniego bitu. W ten sposób wykrywane jest wyst¹pienie zbocza sygna³u. Je¿eli zbocze wyst¹pi³o poza segmentem synchronizacji, mówi siê o tzw. b³êdzie fazy, czyli asynchronicznoœci bitu. Synchronizacja czasów mo¿e odbyæ siê tylko po wykryciu zbocza narastaj¹cego, czyli przejœcia magistrali w stan dominuj¹cy z recesywnego w czasie od ostatniego punktu próbkowania do chwili wykrycia zbocza. W celu kompensacji b³êdu fazy definiuje siê wielkoœæ skoku synchronizacji $SJW$ (Synchronization Jump Width). Jest to wartoœæ maksymalna, o któr¹ w chwili synchronizacji ma prawo zostaæ wyd³u¿ony segment $BS1$, b¹dŸ skrócony segment $BS2$. Wartoœæ $SJW$ wyra¿ana jest w kwantach czasu. B³¹d fazy wynika z ró¿nic w taktowaniu zegarów wêz³ów sieci. Przy u¿ywaniu ma³o dok³adnych, podatnych na temperaturê, tanich rezonatorów nale¿y dobraæ du¿¹ wartoœæ $SJW$~\cite{manual:timing}.

D³ugoœæ kwantu czasu wyliczana jest z nastêpuj¹cej zale¿noœci:
\begin{equation}\label{eq:tq}
t_{q}=\frac{BRP}{f_{clk}}
\end{equation}
gdzie:\\
$t_{q}$ - kwant czasu\\
$BRP$ - Preskaler\\
$f_{clk}$ - czêstotliwoœæ taktowania kontrolera $CAN$\\

Prêdkoœæ transmisji wyznaczana jest ze wzoru:
\begin{equation}\label{eq:baud}
BaudRate=\frac{1}{t_{q}+t_{BS1}+_{BS2}}
\end{equation} 

Instrukcja jak dobieraæ d³ugoœci trwania poszczególnych segmentów zawarta jest w specyfikacji firmy Bosch~\cite{manual:timing}.

\subsection{Filtry akceptacyjne} \label{sec:sub:filtry}
Ogromn¹ zalet¹ systemu opartego na protokole $CAN$ jest obecnoœæ filtrów wiadomoœci. W sieci $CAN$ identyfikator wiadomoœci jest jednoczeœnie jej priorytetem. Im ni¿szy identyfikator, tym wy¿szy priorytet. Wynika to z faktu, ¿e za stan logiczny 0 odpowiada bit dominuj¹cy na magistrali. Dlatego nag³ówek ramki zawieraj¹cy identyfikator nazywany jest polem arbitra¿u. Wêze³, który chce wys³aæ wiadomoœæ o najmniejszym identyfikatorze, uzyska dostêp do magistrali jako pierwszy. Wszystkie wêz³y monitoruj¹ sieæ, równie¿ w trakcie nadawania. Gdy wykryj¹, ¿e wiadomoœæ któr¹ nadaj¹, nie pokrywa siê z t¹ na magistrali, przestaj¹ nadawaæ i oczekuj¹ na koniec ramki. Wtedy ponawiaj¹ próbê nadania wiadomoœci. Algorytm filtracji oraz dostêpu do medium zaimplementowane s¹ sprzêtowo w kontrolerze magistrali $CAN$~\cite{article:can}\cite{article:siecican}.\\

Wa¿nym spostrze¿eniem oraz znacz¹c¹ ró¿nic¹ miêdzy protoko³em $CAN$, a innymi protoko³ami jest fakt, i¿ protokó³ nie posiada adresów. Identyfikator jest powi¹zany z wiadomoœci¹, a nie z urz¹dzeniem. Jako, ¿e ka¿de urz¹dzenie odczytuje stan na magistrali, wysy³anie wiadomoœci odbywa siê w trybie rozg³oszeniowym (broadcast). W wersji podstawowej, dziêki 11-bitowemu identyfikatorowi istnieje 2048 ró¿nych ramek, w rozszerzonej ponad 500 milionów. Nie ma potrzeby aby wszystkie ramki by³y przetwarzane przez wszystkie wêz³y magistrali~\cite{article:can}. Kontrolery $CAN$ umo¿liwiaj¹ filtracjê ramek na poziomie sprzêtowym, bez potrzeby anga¿owania jednostki centralnej. Istniej¹ dwa podstawowe sposoby filtracji wiadomoœci:

\begin{itemize}
\item Tryb maskowania. Definiuje siê maskê, która okreœla, które bity identyfikatora bêd¹ porównywane z wzorcowym identyfikatorem. Dziêki temu trybowi mo¿na w ³atwy sposób zadeklarowaæ zbiór istotnych dla programu identyfikatorów.
\item Tryb listy identyfikatorów. Tworzona jest lista identyfikatorów, które bêd¹ akceptowane przez wêze³. Jest to wygodne rozwi¹zanie w przypadku ma³ej iloœci po¿¹danych wiadomoœci.
\end{itemize}
