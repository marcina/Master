G³ówne zadanie Rozproszonej Jednostki Pomiarowej ($HUB$) to dokonywanie pomiaru wielkoœci fizycznych mierzonych przez czujniki rozmieszczone w bolidzie. Za standard analogowego sygna³u wejœciowego przyjêto 0-12 V. \newline

Uk³ad Jednostki Pomiarowej sk³ada siê z 3 odseparowanych galwanicznie czêœci: pomiarowej, mikrokontrolerowej i transmisji $CAN$.\newline

Uk³ad realizuj¹cy dzia³anie Jednostki to STM32f103, zapewniaj¹c peryferia pomiarowe jak i komunikacyjne.
\subsection{Mikrokontroler}

Mikrokontroler STM32f103 pochodzi z rodziny uk³adów o rdzeniu Cortex\texttrademark-M3. Dostêpny od paru lat na rynku, sprawdza siê w rozwi¹zaniach wymagaj¹cych ma³ego i prostego kontrolera. Szereg peryferiów, w które wyposa¿ony jest ten uk³ad, stawia go w kategorii uniwersalnoœci nie osi¹galnej przez inne uk³ady na rynku tej klasy. Najwa¿niejsze peryferia wykorzystane w Hubie to:\newline
\begin{itemize}
	\item Dwa 12 bitowe przetworniki analogowo-cyfrowe, potrafi¹ce obs³u¿yæ do 16 kana³ów
	\item Interfejs komunikacyjny $CAN$ 2.0B
\end{itemize}

Uk³ad dostarcza tak¿e 7 timerów sprzêtowych, które mog¹ pracowaæ w wielu zaawansowanych trybach. Do wykonywania pomiarów z okreœlonym próbkowaniem wystarcz¹ podstawowe tryby dzia³ania dostarczonych timerów.

\subsection{Separacja sygna³ów analogowych}
Dokonywanie pomiaru odbywa siê za pomoc¹ kana³ów $ADC$ mikrokontrolera. Przyjêty standard napiêcia wymusza sprowadzenie poziomów napiêæ sygna³u do zakresu pracy przetwornika $ADC$. Podczas projektowania rozpatrywano 3 rozwi¹zania:
\begin{itemize}
	\item Rezystancyjny dzielnik napiêcia
	\item Izolacja sygna³ów analogowych przez zewnêtrzny uk³ad $ADC$
	\item Izolacja sygna³ów analogowych na uk³adzie IL300
\end{itemize}
Najprostszym rozwi¹zaniem jest rezystancyjny dzielnik napiêcia. Jest to czwórnik, który zapewnia uzyskanie okreœlonego stosunku pomiêdzy napiêciem wejœciowym, a wyjœciowym~\cite{book:SE}. Rozwi¹zanie tego typu w ¿aden sposób nie zabezpiecza przed podaniem zbyt wysokiego napiêcia oraz wymusza aby sygna³ analogowy by³ mierzony wzglêdem masy Jednostki Pomiarowej. \newline
\begin  {figure} [h] 
\centering
\includegraphics[width=0.75\textwidth]{figures/ADS1100.png}
\caption{Separacja analogowa przy u¿yciu uk³adu ADS1100}
\label{fig:ADS}
\end {figure}

Nastêpn¹ metod¹ separacji, któr¹ brano pod uwagê, by³o wykorzystanie zewnêtrznego uk³adu $ADC$, który przesy³a³by dane po odseparowanej magistrali danych. Zaprojektowane rozwi¹zanie widaæ na \hyperref[fig:ADS]{Rysunku~\ref*{fig:ADS}}. Zosta³o odrzucone, poniewa¿ przetwornik wymaga³ zasilania o napiêciu 5 V, co komplikowa³o uk³ad po stronie nieseparowanej. Dodatkowo takie rozwi¹zania podwy¿sza³o znacz¹co koszt uk³adu. Rozwi¹zanie to sprawdzi³o by siê w aplikacjach w których zale¿y nam na wysokiej dok³adnoœci pomiarów bez wprowadzania przek³amañ, które pojawiaj¹ siê przy separacji analogowej.\newline

Ostatnia opcja, która zosta³a wybrana to separacja przy u¿yciu uk³adu IL300. Uk³ad IL300 posiada jedn¹ diodê nadawcz¹ i dwie diody odbiorcze. Konfiguracja taka pozwala stworzyæ po stronie pierwotnej, sprzê¿enie przez jedn¹ z diod odbiorczych, steruj¹ce pr¹dem diody nadawczej. Kompensuje to nieliniowoœæ œwiecenia diody nadawczej wzglêdem jej pr¹du. Na stronie wtórnej uk³adu IL300 mamy drug¹ diodê odbiorcz¹, której pr¹d jest zale¿ny liniowo od pr¹du diody odbiorczej po stronie pierwotnej~\cite{manual:DesIL300}.\newline

\begin  {figure} [h] 
\centering
\includegraphics[width=0.75\textwidth]{figures/Il300.png}
\caption{Separacja analogowa przy u¿yciu uk³adu IL300}
\label{fig:IL300}
\end {figure}

Na \hyperref[fig:IL300]{Rysunku~\ref*{fig:IL300}} zosta³a pokazana realizacja separacji na uk³adzie IL300. Po stronie pierwotnej mamy uk³ad $U8A$, który przez sprzê¿enie zwrotne linearyzuje diodê nadawcz¹.  Na dodatnie wejœcie wzmacniacza wchodzi sygna³ mierzony podzielony przez dzielnik napiêcia. Sygna³ ten jest porównywany z napiêciem na rezystorze, które jest wymuszone przez pr¹d p³yn¹cy przez diodê odbiorcz¹. Pr¹d diody odbiorczej jest sterowany przez œwiecenie siê diody nadawczej, która jest sterowana przez pr¹d wzmacniacza~\cite{manual:DesIL300}. Wzór na obliczenie wartoœci rezystora to:\newline
\begin{equation} \label{K1} I_F=\frac{V_{in}}{K_1 \cdot R_1} \end{equation}
gdzie:\newline
$I_F$ - pr¹d diody nadawczej\newline
$V_{in}$ - napiêcie na wejœciu nieodwracaj¹cym wzmacniacza\newline
$K_1$-wzmocnienie strony pierwotnej transoptora\newline
$R_1$-Rezystor bocznikowy\newline

Wzmacniacz $U13A$ po stronie wtórnej jest w konfiguracji wtórnika napiêciowego. Na wejœcie nieodwracaj¹ce jest podane napiêcie odk³adaj¹ce siê na boczniku rezystancyjnym. Przez bocznik p³ynie pr¹d diody odbiorczej strony wtórnej~\cite{manual:DesIL300}. Wzór na obliczenie wartoœci rezystora to:\newline
\begin{equation} \label{K2} I_F=\frac{V_{out}}{K_2 \cdot R_2} \end{equation}
gdzie:\newline
$I_F$ - pr¹d diody nadawczej\newline
$V_{out}$ - napiêcie na wyjœciu wzmacniacza\newline
$K_2$-wzmocnienie strony wtórnej transoptora\newline
$R_2$-Rezystor bocznikowy

\noindent Z podstawienia wzoru \ref{K1} do wzoru \ref{K2} dostajemy wzór:\newline
\begin{equation} \label{Pod} \frac{V_{out}}{V_{in}}=\frac{K_2 \cdot R_2}{K_1 \cdot R_1} \end{equation}
W dokumentacji podano wspó³czynnik $K_3$, który równa siê:\newline
\begin{equation} \label{K3} K_3=\frac{K_2}{K_1} \end{equation}
Z tej zale¿noœci wynika ostateczny wzór na rezystancje boczników:\newline
\begin{equation} \label{Ost} \frac{V_{out}}{V_{in}}=\frac{K_3 \cdot R_2}{R_1} \end{equation}

\subsection{Przep³yw danych}
Zadaniem Jednostki Pomiarowej jest wysy³anie zebranych informacji do g³ównego komputera pok³adowego. Nie musi ona odbieraæ ¿adnych wiadomoœci, st¹d maska równa jest 0x1FFFFFFF. Jest to maska, która sprawia, ¿e ka¿dy bit nadchodz¹cego identyfikatora musi siê zgadzaæ z ustawionym identyfikatorem filtra, czyli z identyfikatorem samej jednostki. Oznacza to, ¿e jednostka odczytuje tylko w³asne komunikaty. System filtrowania wiadomoœci omówiono w \hyperref[ssec:filtry]{Sekcji~\ref*{ssec:filtry}: Filtry akceptacyjne}. Realizacja fizyczna Transceivera CAN przedstawiona zosta³a na \hyperref[fig:transceiver]{Rysunku~\ref*{fig:transceiver}}.\\

Ka¿da wiadomoœæ odpowiada innemu kana³owi przetwornika analogowo-cyfrowego. Ka¿da Jednostka Pomiarowa posiada 10 niezale¿nych 12-bitowych kana³ów $ADC$ (\hyperref[fig:adresowanie]{Rysunek~\ref*{fig:adresowanie}}). Czas próbkowania kana³ów $ADC$ definiuje siê w pliku \textit{defines.h}. Ka¿dy $HUB$ posiada swój unikalny adres, który równie¿ zdefiniowany jest w pliku \textit{defines.h}, jako $MY$\_$ID$. Obs³uga przetworników $ADC$ ustawiona jest w tryb skanowania. Oznacza to, ¿e zamiast wykonywania pojedynczych konwersji, wszystkie kana³y skanowane s¹ jeden po drugim automatycznie. W celu szybkiego kopiowania odczytanych wartoœci do pamiêci procesora s³u¿y kontroler $DMA$, omawiany w \hyperref[sec:sub:dma]{Sekcji~\ref*{sec:sub:dma}: Direct Memory Access}. Adres pamiêci, w którym zapisywane s¹ pomiary, przechowuje wskaŸnik $*ADC$\_$Buffer$. Jest to wskaŸnik do 10-elementowej tablicy, która nastêpnie wysy³ana jest na magistralê $CAN$ w przerwaniu od timera $TIM$\_$2$. Obs³ugê przerwania pokazano na  \hyperref[listing:timer]{Listingu~\ref*{listing:timer}}.

\noindent\begin{minipage}{\textwidth}
\begin{lstlisting}[captionpos=b, belowcaptionskip=8pt, caption=Obs³uga przerwania od $TIM$\_$2$, label=listing:timer]
void   TIM2_IRQHandler(void)
{
	if (TIM_GetITStatus(TIM2, TIM_IT_Update) != RESET)
	{
		for(;i<10;i++)
		{
			TxMessage.ExtId = MY_ID & (uint16_t)i<<8;
			TxMessage.IDE = CAN_ID_EXT;
			TxMessage.DLC = 2;
			TxMessage.Data[0] = (uint8_t)ADC_Buffer[i]>>8;
			TxMessage.Data[1] = (uint8_t)ADC_Buffer[i];
			CAN_Transmit(CAN1,&TxMessage);
		}
		TIM_ClearITPendingBit(TIM2, TIM_IT_Update);
	}
}
\end{lstlisting}
\end{minipage}

\subsection{Zasilanie}
Bolid wyposa¿ony jest w zasilanie akumulatorowe 12 V. Do zasilania czêœci mikrokontrolerowej i strony wtórnej separacji analogowej zastosowano przetwornice DC/DC firmy aimtec o napiêciu wyjœciowym 3.3 V. Przetwornica charakteryzuje siê efektywnoœci¹ na poziomie 78\% i zapewnia separacje galwaniczn¹ do 3000 VDC~\cite{manual:aimtec}. Dla stabilnej pracy przetwornicy po stronie pierwotnej i wtórnej zastosowano po dwa kondensatory(tantalowy i elektrolityczny) o wartoœciach 47 $\mu$F i 100 nF.\newline
Kontroler do poprawnego dzia³ania wymaga kondensatorów filtruj¹cych 100 nF na ka¿dym pinie zasilaj¹cym kontrolera oraz dodatkowego kondensatora 4.7 $\mu$F pod³¹czonego bezpoœrednio do pinu $V_{DD3}$. Zasilanie bloku $ADC$ kontrolera wymaga dwóch kondensatorów o wartoœciach 10 nF oraz 1 $\mu$F~\cite{manual:STM32f3}.